<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dovy</title>
    <link rel="stylesheet" href="main.css">
</head>
<body>
    <input type="text" placeholder="&#128269; Search notes and list" id="search">
    <div id="create-container">
        <input type="text" id="title" placeholder="Title">
        <textarea name="" id="notes-input" placeholder="Type your notes here" rows="1"></textarea>
        <button id="close-btn">close</button>
    </div>
    <div id="container"></div>

    <script>
        const search = document.getElementById('search');
        const title = document.getElementById('title');
        const notesInput = document.getElementById('notes-input');
        const inputHeight = window.getComputedStyle(notesInput).height;
        const closeBtn = document.getElementById('close-btn');
        let container = document.getElementById('container');

        function dynamicInput() {
            notesInput.style.height = 'auto';
            notesInput.style.height = notesInput.scrollHeight + 'px';
        }

        console.log(parseInt(window.getComputedStyle(notesInput).fontSize))

        notesInput.addEventListener('input', dynamicInput)

        function currentDate() {
            let d = new Date();
            let year = d.getFullYear();
            let month = d.getMonth();
            let date = d.getDate();
            let hour = d.getHours();
            let minute = String(d.getMinutes()).padStart(2, '0');

            let period = hour >= 12 ? 'PM' : 'AM';
            hour = hour % 12 || 12;

            const monthNames = [
                "Jan", "Feb", "Mar", "Apr", "May", "Jun",
                "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
            ];

            let currentMonth = monthNames[month];

            let time = `${date}/${currentMonth}/${year} at ${hour}:${minute} ${period}`;
            return time;
        }

        currentDate();


        function addCard() {
            if (notesInput.value.trim() !== '') {
                let cardHTML = `
            <div class="card">
             <h1>${title.value}</h1>
            <p>${notesInput.value}</p>
            <p> Created on ${currentDate()}</p>
            </div>`;

                container.innerHTML += cardHTML;

                title.value = '';
                notesInput.value = '';
                notesInput.style.height = inputHeight;

                applyCardEventListeners();
            }
        }

        notesInput.addEventListener('keydown', e => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    addCard();
                }
            })

        search.addEventListener('input', () => {
            const searchTerm = search.value.trim().toLowerCase();
            const allcards = document.querySelectorAll('.card');
            let foundMatch = false;

            allcards.forEach(card => {
                const titleElement = card.querySelector('h1');
                const contentElement = card.querySelector('p');
                const dateElement = card.querySelector('p:last-child');

                if (!titleElement.hasAttribute('data-original')) {
                    titleElement.setAttribute('data-original', titleElement.textContent);
                    contentElement.setAttribute('data-original', contentElement.textContent);
                }

                const originalTitle = titleElement.getAttribute('data-original');
                const originalContent = contentElement.getAttribute('data-original');

                if (searchTerm.length === 0) {
                    titleElement.textContent = originalTitle;
                    contentElement.textContent = originalContent;
                    card.style.display = 'block';
                    foundMatch = true;
                }
                else if (originalTitle.toLowerCase().includes(searchTerm) || originalContent.toLowerCase().includes(searchTerm)) {
                    titleElement.innerHTML = highlightText(originalTitle, searchTerm);
                    contentElement.innerHTML = highlightText(originalContent, searchTerm);
                    dateElement.innerHTML = dateElement.textContent;
                    card.style.display = 'block';

                    foundMatch = true;
                }
                else {
                    card.style.display = 'none';
                }
            });

            const noResultMessage = document.getElementById('no-results-message') || createNoResultsMessage();
            noResultMessage.style.display = foundMatch ? 'none' : 'block';
        })

        function highlightText(text, searchTerm) {
                const regex = new RegExp(`(${escapeRegex(searchTerm)})`, 'gi');
                return text.replace(regex, '<mark class="highlight">$1</mark>');
            }

        function escapeRegex(string) {
                return string.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
            }

        function createNoResultsMessage() {
            let para = document.createElement('p');
            para.id = 'no-results-message';
            para.textContent = 'Nothing found here';
            para.style.display = 'none';
            container.parentNode.insertBefore(para, container.nextSibling);
            return para;
        }
        
        
        let clickedCard = null;

        function applyCardEventListeners() {
            const allcards = document.querySelectorAll('.card');

            for(let i = 0; i < allcards.length; i++) {
                allcards[i].addEventListener('click', (e) => {
                    e.stopPropagation();

                    let card = allcards[i];

                    if (clickedCard && clickedCard !== card) {
                        resetCard(clickedCard);
                    }

                    enlargeCard(card);

                    clickedCard = card;

                    document.addEventListener('click', () => {
                         if (clickedCard) {
                            resetCard(clickedCard);
                            clickedCard = null;
                        }
                    }, {once: true});
                })
            }
        }

        function removeEmptyCard() {
            const allcards = document.querySelectorAll('.card');

            allcards.forEach(card => {
                const titleElement = card.querySelector('h1');
                const contentElement = card.querySelector('p:nth-of-type(1)');
                if(titleElement.textContent.trim() === '' && contentElement.textContent.trim() === '') {
                    container.removeChild(card);
                }
            })
        }

        removeEmptyCard();

        function enlargeCard(card) {
             const randomColor = `rgb(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)})`;

            const titleElement = card.querySelector('h1');
            const contentElement = card.querySelector('p');
            const dateElement = card.querySelector('p:last-child');
             
            if (!titleElement.hasAttribute('data-original')) {
                titleElement.setAttribute('data-original', titleElement.textContent);
                contentElement.setAttribute('data-original', contentElement.textContent);
            }

            card.style.backgroundColor = randomColor;
            card.children[0].setAttribute('contenteditable', 'true');
            card.children[1].setAttribute('contenteditable', 'true');
            card.style.position = 'absolute';
            card.style.transform = 'scale(1.5)';
            card.style.zIndex = '10';
            card.style.overflow = 'auto';

            titleElement.addEventListener('input', (event) => handleEdit(event,dateElement));
            contentElement.addEventListener('input', (event) => handleEdit(event,dateElement));
        }

        function handleEdit(event, dateElement) {
            const element = event.target;
            const originalContent = element.getAttribute('data-original');
            const currentContent = element.textContent;

            if (currentContent !== originalContent) {
                element.setAttribute('data-original', currentContent);
                dateElement.textContent = `Edited on ${currentDate()}`;

                setTimeout(() => { removeEmptyCard() }, 10000);
            }
        }

        function resetCard(card) {
                card.children[0].setAttribute('contenteditable', 'false');
                card.children[1].setAttribute('contenteditable', 'false');
                card.style.position = 'relative';
                card.style.transform = 'scale(1)';
                card.style.zIndex = '1';
                card.style.overflow = 'hidden';
            }

        closeBtn.addEventListener('click', addCard);
    </script>
</body>
</html>